// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  super_admin
  admin
  user
}

enum Platform {
  tiktok
  instagram
}

enum PostStatus {
  draft
  scheduled
  posted
  failed
}

enum WorkflowFrequency {
  daily
  weekly
  monthly
}

enum ContentSource {
  ai_generated
  drafts
  manual
}

model User {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  email       String   @unique
  name        String
  role        Role     @default(user)
  avatar      String?
  // OAuth provider info
  provider    String?  // "google", "facebook", "local", etc.
  providerId  String?  // OAuth provider's user ID
  password    String?  // For local auth (hashed)
  memberSince DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  socialAccounts SocialAccount[]
  posts          Post[]
  workflows      Workflow[]
  incomeEntries  IncomeEntry[]

  @@unique([provider, providerId])
  @@map("users")
}

model SocialAccount {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  userId          String    @db.ObjectId
  platform        Platform
  username        String
  avatar          String?
  followers       Int       @default(0)
  connected       Boolean   @default(false)
  lastSync        DateTime?
  // OAuth: per-user token (e.g. Instagram page access token)
  accessToken     String?
  tokenExpiresAt  DateTime?
  externalId      String?   // e.g. Instagram business account id for API calls
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user  User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts Post[]

  @@unique([userId, platform])
  @@map("social_accounts")
}

model Post {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  userId      String     @db.ObjectId
  socialAccountId String? @db.ObjectId
  platform    Platform
  caption     String
  thumbnail   String?
  status      PostStatus @default(draft)
  scheduledAt DateTime?
  postedAt    DateTime?
  views       Int        @default(0)
  likes       Int        @default(0)
  comments    Int        @default(0)
  shares      Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  socialAccount SocialAccount? @relation(fields: [socialAccountId], references: [id], onDelete: SetNull)

  @@map("posts")
}

model Workflow {
  id           String          @id @default(auto()) @map("_id") @db.ObjectId
  userId       String          @db.ObjectId
  name         String
  platform     Platform
  frequency    WorkflowFrequency
  time         String // e.g., "20:00"
  timezone     String // e.g., "America/New_York"
  contentSource ContentSource
  enabled      Boolean         @default(true)
  nextRun      DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("workflows")
}

model IncomeEntry {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  source    String   // e.g., "Brand deal", "Affiliate", "Sponsored post"
  amount    Float
  date      DateTime
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("income_entries")
}
